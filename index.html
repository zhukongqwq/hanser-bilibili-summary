<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bç«™å¹´åº¦ Hanser æµ“åº¦åˆ†æ (Proç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f5f7; color: #333; }
        h1 { text-align: center; color: #fb7299; margin-bottom: 30px; }
        .box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        #qr-container { text-align: center; }
        #qr-img { border: 1px solid #eee; padding: 10px; border-radius: 8px; }
        .keyword-area { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; }
        .kw-label { padding: 5px 12px; background: #f1f2f3; border-radius: 20px; cursor: pointer; font-size: 13px; user-select: none; border: 1px solid transparent; transition: all 0.2s; }
        .kw-check:checked + .kw-label { background: #e7f5fa; color: #00a1d6; border-color: #00a1d6; font-weight: bold; }
        .kw-check { display: none; }
        .custom-tag-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .custom-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 200px; outline: none; }
        .custom-btn { padding: 8px 15px; background: #fb7299; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .progress-wrapper { margin-bottom: 20px; }
        .progress-bg { width: 100%; background: #e7e7e7; height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #fb7299, #c4587a); transition: width 0.3s ease; }
        .status-text { text-align: center; font-size: 14px; color: #666; margin-top: 8px; }
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-num { font-size: 28px; font-weight: bold; color: #333; }
        .stat-label { font-size: 13px; color: #888; }
        .highlight { color: #fb7299; }
        .chart-container { position: relative; height: 350px; width: 100%; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap; }
        .btn { background: #00a1d6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 15px; transition: background 0.2s; }
        .btn:hover { background: #00b5e5; }
        .btn.stop { background: #ff5050; }
        .btn.clear { background: #95a5a6; }
        .btn.ai { background: #6c5ce7; font-weight: bold; }
        .btn.logout { background: transparent; color: #999; border: 1px solid #ddd; padding: 8px 16px; font-size: 13px; }
        .btn.logout:hover { color: #ff5050; border-color: #ff5050; }
        .hidden { display: none; }
        .server-notice { font-size: 12px; color: #999; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>ğŸ“Š Bç«™å¹´åº¦ Hanser æµ“åº¦åˆ†æ</h1>

    <!-- 1. ç™»å½•æ¨¡å— -->
    <div id="login-section" class="box">
        <div id="qr-container">
            <img id="qr-img" src="" width="180" alt="äºŒç»´ç " />
            <div style="margin-top:10px; color:#666;">è¯·ä½¿ç”¨ Bilibili App æ‰«ç ç™»å½•</div>
        </div>
    </div>

    <!-- 2. åˆ†æä»ªè¡¨ç›˜ -->
    <div id="dashboard-section" class="box hidden">
        <div class="keyword-area" id="keyword-container"></div>

        <div class="custom-tag-row">
            <input type="text" id="custom-tag-input" class="custom-input" placeholder="æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾ (å¦‚: å´©å3)">
            <button class="custom-btn" onclick="addCustomTag()">æ·»åŠ  Tag</button>
        </div>

        <div class="progress-wrapper">
            <div class="progress-bg"><div class="progress-fill" id="progress-bar"></div></div>
            <div class="status-text" id="status-text">å‡†å¤‡å°±ç»ª</div>
        </div>

        <div class="result-grid">
            <div class="stat-card">
                <div class="stat-num" id="total-scanned">0</div>
                <div class="stat-label">å·²æ‰«æ/å·²ä¿å­˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-num highlight" id="total-concentration">0%</div>
                <div class="stat-label">æ€»æµ“åº¦</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>

        <div class="controls">
            <button class="btn" id="start-btn" onclick="startFetching()">ğŸš€ å¼€å§‹å›æº¯</button>
            <button class="btn stop hidden" id="stop-btn" onclick="stopFetching()">â¹ æš‚åœå¹¶ä¿å­˜</button>
            <button class="btn clear" onclick="clearData()">ğŸ—‘ æ¸…ç©ºäº‘ç«¯å­˜æ¡£</button>
            <button class="btn ai" onclick="goToAIAnalysis()">ğŸ§  å‰å¾€ AI æ·±åº¦ç”»åƒ</button>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn logout" onclick="logout()">é€€å‡ºç™»å½• / åˆ‡æ¢è´¦å·</button>
        </div>
    </div>
    
    <div class="server-notice">æ•°æ®ä»…ä¿å­˜åœ¨æœåŠ¡å™¨ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œ24å°æ—¶æœªæ´»åŠ¨å°†è‡ªåŠ¨æ¸…ç†ã€‚</div>

    <script>
        // === 1. Client ID & Session ===
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        let clientId = localStorage.getItem('bili_client_id');
        if (!clientId) {
            clientId = generateUUID();
            localStorage.setItem('bili_client_id', clientId);
        }

        // === 2. å˜é‡ ===
        const defaultKeywords = [
            { id: 'hanser', label: 'Hanser', checked: true },
            { id: 'hanse', label: 'æ†¨è‰²', checked: true },
            { id: 'silverwolf', label: 'é“¶ç‹¼', checked: true },
            { id: 'bronya', label: 'å¸ƒæ´›å¦®å¨…', checked: true },
            { id: 'duck', label: 'æ¿é¸­', checked: false },
            { id: 'starrail', label: 'æ˜Ÿç©¹é“é“', checked: false },
            { id: 'honkai', label: 'å´©å3', checked: false },
            { id: 'zzz', label: 'ç»åŒºé›¶', checked: false }
        ];

        let qrcodeKey = '';
        let userCookie = '';
        let isFetching = false;
        let allHistoryData = []; 
        let currentCursor = null;
        let chartInstance = null;

        // === 3. åˆå§‹åŒ– ===
        function init() {
            renderKeywords();
            initChart();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç™»å½•çŠ¶æ€ (24å°æ—¶å†…)
            if (checkSavedSession()) {
                console.log('Session restored');
                showDashboard();
            } else {
                getQRCode();
            }
        }

        // === Session ç®¡ç†é€»è¾‘ ===
        function saveSession(cookie) {
            const session = {
                cookie: cookie,
                expiry: Date.now() + 24 * 60 * 60 * 1000 // 24å°æ—¶åè¿‡æœŸ
            };
            localStorage.setItem('bili_session', JSON.stringify(session));
        }

        function checkSavedSession() {
            const sessionStr = localStorage.getItem('bili_session');
            if (!sessionStr) return false;
            
            try {
                const session = JSON.parse(sessionStr);
                if (Date.now() < session.expiry) {
                    userCookie = session.cookie;
                    return true;
                } else {
                    localStorage.removeItem('bili_session'); // è¿‡æœŸæ¸…é™¤
                    return false;
                }
            } catch (e) { return false; }
        }

        function logout() {
            localStorage.removeItem('bili_session');
            location.reload();
        }

        function showDashboard() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            loadSavedProgress();
        }

        // === 4. åŸºç¡€ UI å‡½æ•° ===
        function renderKeywords() {
            const container = document.getElementById('keyword-container');
            container.innerHTML = defaultKeywords.map(k => `
                <input type="checkbox" id="kw-${k.id}" class="kw-check" value="${k.label}" ${k.checked ? 'checked' : ''} onchange="updateStats()">
                <label for="kw-${k.id}" class="kw-label">${k.label}</label>
            `).join('');
        }

        function addCustomTag() {
            const input = document.getElementById('custom-tag-input');
            const val = input.value.trim();
            if (!val) return;
            const id = 'custom-' + Date.now();
            const container = document.getElementById('keyword-container');
            container.insertAdjacentHTML('beforeend', `
                <input type="checkbox" id="${id}" class="kw-check" value="${val}" checked onchange="updateStats()">
                <label for="${id}" class="kw-label">${val}</label>
            `);
            input.value = '';
            updateStats();
        }

        function goToAIAnalysis() {
            if (allHistoryData.length === 0) {
                alert('è¯·å…ˆè·å–æ•°æ®');
                return;
            }
            window.location.href = `/analysis?clientId=${clientId}`;
        }

        function initChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å‡ºç°æ¬¡æ•°',
                        data: [],
                        backgroundColor: 'rgba(251, 114, 153, 0.6)',
                        borderColor: 'rgba(251, 114, 153, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // === 5. ç™»å½•æµç¨‹ ===
        async function getQRCode() {
            try {
                const res = await fetch('/get-qrcode');
                const data = await res.json();
                document.getElementById('qr-img').src = data.qrImage;
                qrcodeKey = data.qrcode_key;
                pollLoginStatus();
            } catch (e) { alert('æœåŠ¡å™¨è¿æ¥å¤±è´¥'); }
        }

        function pollLoginStatus() {
            const timer = setInterval(async () => {
                const res = await fetch(`/check-login?qrcode_key=${qrcodeKey}`);
                const data = await res.json();
                if (data.status === 'success') {
                    clearInterval(timer);
                    userCookie = data.cookie;
                    
                    // ç™»å½•æˆåŠŸï¼Œä¿å­˜ Session
                    saveSession(userCookie);
                    
                    showDashboard();
                }
            }, 2000);
        }

        // === 6. æ•°æ®é€»è¾‘ ===
        async function loadSavedProgress() {
            try {
                const res = await fetch('/load-progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientId })
                });
                const data = await res.json();
                if (data.list && data.list.length > 0) {
                    allHistoryData = data.list;
                    currentCursor = data.cursor;
                    updateStats();
                    const lastItem = allHistoryData[allHistoryData.length - 1];
                    updateProgressBar(lastItem.view_at);
                    document.getElementById('start-btn').innerText = `ğŸš€ ç»§ç»­å›æº¯ (å·²å­˜ ${allHistoryData.length} æ¡)`;
                    document.getElementById('status-text').innerText = 'å·²åŠ è½½äº‘ç«¯å­˜æ¡£';
                }
            } catch (e) { console.log('æ— å­˜æ¡£'); }
        }

        async function clearData() {
            if (!confirm('ç¡®å®šæ¸…ç©ºäº‘ç«¯å­˜æ¡£ï¼Ÿ')) return;
            await fetch('/clear-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ clientId })
            });
            allHistoryData = [];
            currentCursor = null;
            updateStats();
            document.getElementById('start-btn').innerText = 'ğŸš€ å¼€å§‹å›æº¯';
            document.getElementById('status-text').innerText = 'å­˜æ¡£å·²æ¸…ç©º';
            document.getElementById('progress-bar').style.width = '0%';
        }

        async function startFetching() {
            if (isFetching) return;
            isFetching = true;
            document.getElementById('start-btn').classList.add('hidden');
            document.getElementById('stop-btn').classList.remove('hidden');
            document.querySelectorAll('.kw-check').forEach(el => el.disabled = true);

            const now = Date.now() / 1000;
            const oneYearSeconds = 365 * 24 * 60 * 60;
            const oneYearAgo = now - oneYearSeconds;
            
            try {
                while (isFetching) {
                    const res = await fetch('/get-history-page', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cookie: userCookie, cursor: currentCursor })
                    });
                    const data = await res.json();

                    // å¦‚æœ Cookie å¤±æ•ˆ (Bç«™è¿”å›é”™è¯¯)
                    if (data.error) {
                         alert('ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
                         logout();
                         return;
                    }

                    if (!data.list || data.list.length === 0) {
                        stopFetching('å·²åˆ°è¾¾è®°å½•å°½å¤´');
                        break;
                    }

                    await fetch('/save-batch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newItems: data.list, cursor: data.cursor, clientId: clientId })
                    });

                    allHistoryData.push(...data.list);
                    currentCursor = data.cursor;

                    const lastItemTime = data.list[data.list.length - 1].view_at;
                    updateProgressBar(lastItemTime);
                    updateStats();

                    if (lastItemTime < oneYearAgo) {
                        stopFetching('å·²å®Œæˆä¸€å¹´æ•°æ®æ‰«æ');
                        break;
                    }
                    await new Promise(r => setTimeout(r, 1500));
                }
            } catch (err) {
                console.error(err);
                stopFetching('ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡ä¸­æ–­');
            }
        }

        function stopFetching(msg = 'æš‚åœ') {
            isFetching = false;
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
            document.getElementById('start-btn').innerText = `ğŸš€ ç»§ç»­å›æº¯ (å·²å­˜ ${allHistoryData.length} æ¡)`;
            document.getElementById('status-text').innerText = `çŠ¶æ€: ${msg}`;
            document.querySelectorAll('.kw-check').forEach(el => el.disabled = false);
        }

        function updateProgressBar(timestamp) {
            const now = Date.now() / 1000;
            const oneYearSeconds = 365 * 24 * 60 * 60;
            const percent = Math.min(100, ((now - timestamp) / oneYearSeconds) * 100);
            const dateStr = new Date(timestamp * 1000).toLocaleDateString();
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('status-text').innerText = `å›æº¯è‡³: ${dateStr} (${percent.toFixed(1)}%)`;
        }

        function updateStats() {
            const checkboxes = document.querySelectorAll('.kw-check:checked');
            const activeKeywords = Array.from(checkboxes).map(cb => cb.value);

            if (allHistoryData.length === 0) {
                chartInstance.data.labels = activeKeywords;
                chartInstance.data.datasets[0].data = activeKeywords.map(() => 0);
                chartInstance.update();
                return;
            }

            let totalHitCount = 0;
            const keywordCounts = {}; 
            activeKeywords.forEach(k => keywordCounts[k] = 0);

            allHistoryData.forEach(item => {
                const fullText = `${item.title} ${item.desc} ${item.tags} ${item.author}`.toLowerCase();
                let isHit = false;
                activeKeywords.forEach(key => {
                    if (fullText.includes(key.toLowerCase())) {
                        keywordCounts[key]++;
                        isHit = true;
                    }
                });
                if (isHit) totalHitCount++;
            });

            document.getElementById('total-scanned').innerText = allHistoryData.length;
            const concentration = ((totalHitCount / allHistoryData.length) * 100).toFixed(1);
            document.getElementById('total-concentration').innerText = `${concentration}%`;

            chartInstance.data.labels = activeKeywords;
            chartInstance.data.datasets[0].data = activeKeywords.map(k => keywordCounts[k]);
            chartInstance.update();
        }

        init();
    </script>
</body>
</html>
