<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bç«™å¹´åº¦ Hanser æµ“åº¦åˆ†æ (äº‘ç«¯ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f5f7; color: #333; }
        h1 { text-align: center; color: #fb7299; margin-bottom: 30px; }
        .box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        #qr-container { text-align: center; }
        #qr-img { border: 1px solid #eee; padding: 10px; border-radius: 8px; }
        .keyword-area { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; }
        .kw-label { padding: 5px 12px; background: #f1f2f3; border-radius: 20px; cursor: pointer; font-size: 13px; user-select: none; border: 1px solid transparent; transition: all 0.2s; }
        .kw-check:checked + .kw-label { background: #e7f5fa; color: #00a1d6; border-color: #00a1d6; font-weight: bold; }
        .kw-check { display: none; }
        .custom-tag-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .custom-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 200px; outline: none; }
        .custom-btn { padding: 8px 15px; background: #fb7299; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .progress-wrapper { margin-bottom: 20px; }
        .progress-bg { width: 100%; background: #e7e7e7; height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #fb7299, #c4587a); transition: width 0.3s ease; }
        .status-text { text-align: center; font-size: 14px; color: #666; margin-top: 8px; }
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-num { font-size: 28px; font-weight: bold; color: #333; }
        .stat-label { font-size: 13px; color: #888; }
        .highlight { color: #fb7299; }
        .chart-container { position: relative; height: 350px; width: 100%; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap; }
        .btn { background: #00a1d6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 15px; transition: background 0.2s; }
        .btn:hover { background: #00b5e5; }
        .btn.stop { background: #ff5050; }
        .btn.clear { background: #95a5a6; }
        .btn.ai { background: #6c5ce7; font-weight: bold; }
        .btn.download { background: #27ae60; }
        .btn.upload { background: #f39c12; }
        .btn.logout { background: transparent; color: #999; border: 1px solid #ddd; padding: 8px 16px; font-size: 13px; }
        .hidden { display: none; }
        .uid-tag { background: #fb7299; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px; }
    </style>
</head>
<body>

    <h1>ğŸ“Š Bç«™å¹´åº¦ Hanser æµ“åº¦åˆ†æ</h1>

    <div id="login-section" class="box">
        <div id="qr-container">
            <img id="qr-img" src="" width="180" alt="äºŒç»´ç " />
            <div style="margin-top:10px; color:#666;">è¯·ä½¿ç”¨ Bilibili App æ‰«ç ç™»å½•</div>
        </div>
    </div>

    <div id="dashboard-section" class="box hidden">
        <div style="text-align:center; margin-bottom:15px; color:#666;">
            å½“å‰ç”¨æˆ· UID: <span id="current-uid" class="uid-tag">Loading...</span>
        </div>

        <div class="keyword-area" id="keyword-container"></div>
        <div class="custom-tag-row">
            <input type="text" id="custom-tag-input" class="custom-input" placeholder="æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾">
            <button class="custom-btn" onclick="addCustomTag()">æ·»åŠ </button>
        </div>

        <div class="progress-wrapper">
            <div class="progress-bg"><div class="progress-fill" id="progress-bar"></div></div>
            <div class="status-text" id="status-text">å‡†å¤‡å°±ç»ª</div>
        </div>

        <div class="result-grid">
            <div class="stat-card">
                <div class="stat-num" id="total-scanned">0</div>
                <div class="stat-label">å·²æ‰«æ (äº‘ç«¯)</div>
            </div>
            <div class="stat-card">
                <div class="stat-num highlight" id="total-concentration">0%</div>
                <div class="stat-label">æ€»æµ“åº¦</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>

        <div class="controls">
            <button class="btn" id="start-btn" onclick="startServerScan()">ğŸš€ å¯åŠ¨åå°æ‰«æ</button>
            <button class="btn stop hidden" id="stop-btn" onclick="stopServerScan()">â¹ åœæ­¢æ‰«æ</button>
            
            <button class="btn download" onclick="downloadData()">ğŸ“¥ ä¸‹è½½æ•°æ®</button>
            <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼  input -->
            <input type="file" id="file-upload" style="display:none" accept=".json" onchange="handleFileUpload(this)">
            <button class="btn upload" onclick="document.getElementById('file-upload').click()">ğŸ“¤ ä¸Šä¼ å­˜æ¡£</button>
            
            <button class="btn clear" onclick="clearData()">ğŸ—‘ æ¸…ç©º</button>
            <button class="btn ai" onclick="goToAIAnalysis()">ğŸ§  AI æ·±åº¦ç”»åƒ</button>
        </div>
        
        <div style="text-align:center; margin-top:15px;">
             <button class="btn" style="background:#34495e; font-size:12px; padding:8px 15px;" onclick="saveChartImage()">ğŸ“¸ ä¿å­˜å›¾è¡¨ä¸ºå›¾ç‰‡</button>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn logout" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>
    
    <div style="text-align:center; color:#999; font-size:12px; margin-top:20px;">
        æç¤ºï¼šä»»åŠ¡åœ¨æœåŠ¡å™¨åå°è¿è¡Œï¼Œæ‚¨å¯ä»¥æ”¾å¿ƒå…³é—­æ­¤é¡µé¢ï¼Œç¨åå†æ¥æŸ¥çœ‹è¿›åº¦ã€‚
    </div>

    <script>
        const defaultKeywords = [
            { id: 'hanser', label: 'Hanser', checked: true },
            { id: 'hanse', label: 'æ†¨è‰²', checked: true },
            { id: 'silverwolf', label: 'é“¶ç‹¼', checked: true },
            { id: 'bronya', label: 'å¸ƒæ´›å¦®å¨…', checked: true },
            { id: 'duck', label: 'æ¿é¸­', checked: false },
            { id: 'starrail', label: 'æ˜Ÿç©¹é“é“', checked: false },
            { id: 'honkai', label: 'å´©å3', checked: false },
            { id: 'zzz', label: 'ç»åŒºé›¶', checked: false }
        ];

        let qrcodeKey = '';
        let userCookie = '';
        let currentUid = '';
        let statusTimer = null;
        let chartInstance = null;
        let allHistoryData = [];

        function init() {
            renderKeywords();
            initChart();
            if (checkSavedSession()) showDashboard();
            else getQRCode();
        }

        function saveSession(cookie, uid) { localStorage.setItem('bili_session_v2', JSON.stringify({ cookie, uid, expiry: Date.now() + 86400000 })); }
        function checkSavedSession() {
            try {
                const s = JSON.parse(localStorage.getItem('bili_session_v2'));
                if (s && Date.now() < s.expiry) { userCookie = s.cookie; currentUid = s.uid; return true; }
            } catch(e){}
            return false;
        }
        function logout() { localStorage.removeItem('bili_session_v2'); location.reload(); }
        
        function showDashboard() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('current-uid').innerText = currentUid;
            pollServerStatus();
            statusTimer = setInterval(pollServerStatus, 2000);
        }

        async function startServerScan() {
            try {
                const res = await fetch('/start-scan', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ uid: currentUid, cookie: userCookie }) });
                const data = await res.json();
                if(data.success) { alert('åå°æ‰«æå·²å¯åŠ¨'); pollServerStatus(); } else alert(data.msg);
            } catch(e) { alert('è¯·æ±‚å¤±è´¥'); }
        }

        async function stopServerScan() {
            await fetch('/stop-scan', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ uid: currentUid }) });
        }

        async function pollServerStatus() {
            try {
                const res = await fetch(`/scan-status?uid=${currentUid}`);
                const data = await res.json();
                
                const isRunning = data.status === 'running';
                if (isRunning) {
                    document.getElementById('start-btn').classList.add('hidden');
                    document.getElementById('stop-btn').classList.remove('hidden');
                } else {
                    document.getElementById('start-btn').classList.remove('hidden');
                    document.getElementById('stop-btn').classList.add('hidden');
                }

                const percent = data.lastTime ? Math.min(100, ((Date.now()/1000 - data.lastTime) / (365*24*3600)) * 100).toFixed(1) : 0;
                const dateStr = data.lastTime ? new Date(data.lastTime * 1000).toLocaleDateString() : 'æœªçŸ¥';
                
                document.getElementById('status-text').innerText = `[${data.status}] ${data.msg} (è¿›åº¦: ${percent}%)`;
                document.getElementById('progress-bar').style.width = `${percent}%`;
                document.getElementById('total-scanned').innerText = data.total;

                if (data.total > 0 && data.total !== allHistoryData.length) loadFullData(); 

            } catch(e) {}
        }

        async function loadFullData() {
            try {
                const res = await fetch('/load-data', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ uid: currentUid }) });
                const data = await res.json();
                if(data.list) { allHistoryData = data.list; updateChart(); }
            } catch(e){}
        }

        function downloadData() { window.open(`/download-data?uid=${currentUid}`, '_blank'); }

        // === æ ¸å¿ƒï¼šä¸Šä¼ æ–‡ä»¶ ===
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    if (!jsonData.list) throw new Error('æ— æ•ˆçš„å­˜æ¡£æ–‡ä»¶');
                    
                    const res = await fetch('/upload-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ uid: currentUid, data: jsonData })
                    });
                    
                    const resData = await res.json();
                    if (resData.success) {
                        alert('å­˜æ¡£ä¸Šä¼ æˆåŠŸï¼');
                        loadFullData(); // åˆ·æ–°ç•Œé¢
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥');
                    }
                } catch (err) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥: ' + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ''; // æ¸…ç©ºä»¥å…è®¸é‡å¤ä¸Šä¼ 
        }

        // === æ ¸å¿ƒï¼šä¿å­˜å›¾è¡¨å›¾ç‰‡ ===
        function saveChartImage() {
            const canvas = document.getElementById('myChart');
            const link = document.createElement('a');
            link.download = `Hanser_Chart_${currentUid}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        async function clearData() {
            if(!confirm('ç¡®å®šåˆ é™¤äº‘ç«¯å­˜æ¡£ï¼Ÿ')) return;
            await fetch('/clear-data', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ uid: currentUid }) });
            location.reload();
        }

        function renderKeywords() {
            document.getElementById('keyword-container').innerHTML = defaultKeywords.map(k => `
                <input type="checkbox" id="kw-${k.id}" class="kw-check" value="${k.label}" ${k.checked ? 'checked' : ''} onchange="updateChart()">
                <label for="kw-${k.id}" class="kw-label">${k.label}</label>
            `).join('');
        }
        function addCustomTag() {
            const val = document.getElementById('custom-tag-input').value.trim();
            if(!val) return;
            const id = 'custom-' + Date.now();
            document.getElementById('keyword-container').insertAdjacentHTML('beforeend', `
                <input type="checkbox" id="${id}" class="kw-check" value="${val}" checked onchange="updateChart()">
                <label for="${id}" class="kw-label">${val}</label>
            `);
            updateChart();
        }
        function initChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'å‡ºç°æ¬¡æ•°', data: [], backgroundColor: 'rgba(251, 114, 153, 0.6)', borderColor: 'rgba(251, 114, 153, 1)', borderWidth: 1, borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }
        function updateChart() {
            if(allHistoryData.length === 0) return;
            const activeKeywords = Array.from(document.querySelectorAll('.kw-check:checked')).map(cb => cb.value);
            const counts = {}; activeKeywords.forEach(k => counts[k] = 0);
            let hits = 0;
            allHistoryData.forEach(item => {
                const str = (item.title + item.desc + item.tags + item.author).toLowerCase();
                let isHit = false;
                activeKeywords.forEach(k => { if(str.includes(k.toLowerCase())) { counts[k]++; isHit = true; }});
                if(isHit) hits++;
            });
            document.getElementById('total-concentration').innerText = ((hits/allHistoryData.length)*100).toFixed(1) + '%';
            chartInstance.data.labels = activeKeywords;
            chartInstance.data.datasets[0].data = activeKeywords.map(k => counts[k]);
            chartInstance.update();
        }
        function goToAIAnalysis() {
            if(allHistoryData.length === 0) return alert('è¯·å…ˆè·å–æ•°æ®');
            window.location.href = `/analysis?clientId=${currentUid}`; 
        }
        async function getQRCode() {
            try {
                const res = await fetch('/get-qrcode');
                const data = await res.json();
                document.getElementById('qr-img').src = data.qrImage;
                qrcodeKey = data.qrcode_key;
                const timer = setInterval(async () => {
                    const lRes = await fetch(`/check-login?qrcode_key=${qrcodeKey}`);
                    const lData = await lRes.json();
                    if (lData.status === 'success') {
                        clearInterval(timer);
                        userCookie = lData.cookie;
                        currentUid = lData.uid; 
                        saveSession(userCookie, currentUid);
                        showDashboard();
                    }
                }, 2000);
            } catch(e){}
        }

        init();
    </script>
</body>
</html>
