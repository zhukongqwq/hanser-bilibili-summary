<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanser æµ“åº¦ AI æ·±åº¦åˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f5f7; color: #333; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #6c5ce7; }
        
        .box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .loading { text-align: center; color: #666; font-size: 18px; padding: 50px; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #6c5ce7; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Markdown æ ·å¼ */
        .markdown-body { line-height: 1.6; }
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 20px; }
        .markdown-body ul { padding-left: 20px; }
        .markdown-body li { margin-bottom: 5px; }
        .markdown-body strong { color: #fb7299; }
        
        .btn { display: block; width: 200px; margin: 20px auto; padding: 12px; background: #6c5ce7; color: white; text-align: center; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; font-size: 16px; }
        .btn:hover { background: #5b4cc4; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ§  AI æ·±åº¦ç”»åƒæŠ¥å‘Š</h1>
        <p>åŸºäºæ‚¨æœ€è¿‘ä¸€å¹´çš„ Hanser ç›¸å…³æµè§ˆè®°å½•</p>
    </div>

    <div id="content-area" class="box">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨åŠ è½½æ•°æ®å¹¶å¬å”¤ AI åˆ†æä¸­...<br><span style="font-size:12px;color:#999">è¿™å¯èƒ½éœ€è¦ 10-30 ç§’</span></div>
        </div>
        <div id="report" class="markdown-body" style="display:none;"></div>
    </div>

    <a href="/" class="btn">è¿”å›æ‰«æé¡µ</a>

    <script>
        // è·å– URL å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('clientId');

        async function startAnalysis() {
            if (!clientId) {
                showError('æœªæ‰¾åˆ°ç”¨æˆ· IDï¼Œè¯·ä»ä¸»é¡µè·³è½¬è¿›å…¥ã€‚');
                return;
            }

            try {
                // 1. åŠ è½½ç”¨æˆ·æ•°æ®
                const loadRes = await fetch('/load-progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientId })
                });
                const data = await loadRes.json();
                
                if (!data.list || data.list.length === 0) {
                    showError('æš‚æ— æµè§ˆæ•°æ®ï¼Œè¯·å…ˆå»æ‰«æã€‚');
                    return;
                }

                // 2. ç­›é€‰ Hanser ç›¸å…³è§†é¢‘ (æœ¬åœ°ç®€å•ç­›é€‰ï¼Œå‡å°‘ä¼ è¾“é‡)
                const keywords = ['hanser', 'æ†¨è‰²', '255', 'é“¶ç‹¼', 'å¸ƒæ´›å¦®å¨…', 'æ¿é¸­'];
                const filteredList = data.list.filter(item => {
                    const str = (item.title + item.desc + item.tags + item.author).toLowerCase();
                    return keywords.some(k => str.includes(k));
                });

                if (filteredList.length === 0) {
                    showError('ä½ çš„è®°å½•é‡Œä¼¼ä¹æ²¡æœ‰æ£€æµ‹åˆ° Hanser ç›¸å…³çš„è§†é¢‘ï¼ŒAI æ— æ³•åˆ†æã€‚');
                    return;
                }

                // 3. å‘é€ç»™åç«¯ AI æ¥å£
                const aiRes = await fetch('/analyze-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoData: filteredList })
                });

                const aiData = await aiRes.json();

                if (aiData.error) {
                    showError('AI åˆ†æå¤±è´¥: ' + aiData.error);
                } else {
                    renderReport(aiData.result);
                }

            } catch (e) {
                console.error(e);
                showError('ç½‘ç»œè¯·æ±‚é”™è¯¯');
            }
        }

        function renderReport(markdownText) {
            document.getElementById('loading').style.display = 'none';
            const reportDiv = document.getElementById('report');
            reportDiv.style.display = 'block';
            reportDiv.innerHTML = marked.parse(markdownText);
        }

        function showError(msg) {
            document.getElementById('loading').innerHTML = `<p style="color:red">${msg}</p>`;
        }

        // é¡µé¢åŠ è½½å³å¼€å§‹
        startAnalysis();
    </script>
</body>
</html>
