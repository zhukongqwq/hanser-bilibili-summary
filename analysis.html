<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanser æµ“åº¦ AI æ·±åº¦åˆ†æ</title>
    <!-- å¼•å…¥ Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥ ç½‘é¡µæˆªå›¾åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f5f7; color: #333; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #6c5ce7; }
        
        /* === æŠ¥å‘Šå¡ç‰‡æ ·å¼ === */
        .report-card { 
            background: white; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            position: relative;
            overflow: visible; 
            /* ã€æ–°å¢ã€‘ç¡®ä¿é«˜åº¦è‡ªé€‚åº”ï¼Œä¸ç•™å¤šä½™ç©ºç™½ */
            height: auto; 
            min-height: 200px;
        }
        
        .loading { text-align: center; color: #666; font-size: 18px; padding: 50px; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #6c5ce7; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* === Markdown æ ·å¼ä¼˜åŒ– === */
        .markdown-body { 
            line-height: 2.0; 
            font-size: 16px; 
            word-wrap: break-word; 
        }
        
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 30px; color: #2c3e50; }
        .markdown-body h3 { margin-top: 25px; color: #6c5ce7; }
        .markdown-body ul { padding-left: 20px; }
        .markdown-body li { margin-bottom: 10px; }
        
        .markdown-body strong { 
            color: #fb7299; 
            background: #fff0f6; 
            padding: 2px 6px; 
            border-radius: 4px; 
            display: inline-block; 
            margin: 0 2px;
            line-height: 1.4; 
        }
        
        .markdown-body blockquote { border-left: 4px solid #ddd; padding-left: 15px; color: #777; margin: 15px 0; background: #f9f9f9; padding: 10px; border-radius: 4px; }
        
        /* === æŒ‰é’®åŒºåŸŸ === */
        .action-bar { display: flex; justify-content: center; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; font-size: 16px; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn-back { background: #e0e0e0; color: #333; }
        .btn-back:hover { background: #d0d0d0; }
        .btn-md { background: #27ae60; color: white; display: none; }
        .btn-md:hover { background: #219150; transform: translateY(-2px); }
        .btn-save { background: #6c5ce7; color: white; display: none; }
        .btn-save:hover { background: #5b4cc4; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }
        
        .cache-badge { position: absolute; top: 20px; right: 20px; background: #e1f5fe; color: #0288d1; font-size: 12px; padding: 4px 10px; border-radius: 20px; display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ§  AI æ·±åº¦ç”»åƒæŠ¥å‘Š</h1>
        <p>åŸºäºæ‚¨æœ€è¿‘ä¸€å¹´çš„ Hanser ç›¸å…³æµè§ˆè®°å½•</p>
    </div>

    <!-- æˆªå›¾åŒºåŸŸ -->
    <div id="capture-area" class="report-card">
        <span id="cache-badge" class="cache-badge">âš¡ å·²åŠ è½½å†å²åˆ†æ (æ•°æ®æœªå˜)</span>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨åŠ è½½æ•°æ®å¹¶å¬å”¤ AI åˆ†æä¸­...<br><span style="font-size:12px;color:#999">è¿™å¯èƒ½éœ€è¦ 10-30 ç§’</span></div>
        </div>
        <div id="report" class="markdown-body" style="display:none;"></div>
        
        <!-- æ°´å° -->
        <div id="watermark" style="display:none; text-align:center; margin-top:40px; color:#ccc; font-size:12px; border-top:1px dashed #eee; padding-top:15px;">
            Generated by Bilibili Hanser Analyzer
        </div>
    </div>

    <div class="action-bar">
        <a href="/" class="btn btn-back">â¬…ï¸ è¿”å›</a>
        <button id="btn-dl-md" class="btn btn-md" onclick="downloadMarkdown()">ğŸ“¥ ä¸‹è½½ Markdown</button>
        <button id="btn-save" class="btn btn-save" onclick="saveAsImage()">ğŸ“¸ ä¿å­˜ä¸ºå›¾ç‰‡</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('clientId'); 
        let rawMarkdownContent = "";

        const keywordsMap = {
            'Hanseræœ¬ä½“': ['hanser', 'æ†¨è‰²', '255'],
            'é“¶ç‹¼/å¸ƒæ´›å¦®å¨…': ['é“¶ç‹¼', 'å¸ƒæ´›å¦®å¨…', 'æ¿é¸­', 'ç†ä¹‹å¾‹è€…'],
            'æ˜Ÿç©¹é“é“': ['æ˜Ÿç©¹é“é“', 'å´©åæ˜Ÿç©¹é“é“'],
            'å´©å3': ['å´©å3', 'honkai'],
            'ç¿»å”±/æ­Œæ›²': ['ç¿»å”±', 'æ­Œ', 'mv', 'cover'],
            'é¬¼ç•œ/æ•´æ´»': ['é¬¼ç•œ', 'äººåŠ›', 'å¡«è¯']
        };

        async function startAnalysis() {
            if (!clientId) return showError('æœªæ‰¾åˆ°ç”¨æˆ· IDï¼Œè¯·ä»ä¸»é¡µè·³è½¬è¿›å…¥ã€‚');

            try {
                const loadRes = await fetch('/load-data', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ uid: clientId }) });
                const data = await loadRes.json();
                if (!data.list || data.list.length === 0) return showError('æš‚æ— æµè§ˆæ•°æ®ã€‚');

                const totalScanned = data.list.length;
                const filteredList = [];
                const tagCounts = {};
                for (let key in keywordsMap) tagCounts[key] = 0;

                data.list.forEach(item => {
                    const str = (item.title + item.desc + item.tags + item.author).toLowerCase();
                    const allKeywords = Object.values(keywordsMap).flat();
                    if (allKeywords.some(k => str.includes(k))) {
                        filteredList.push(item);
                        for (let [category, kws] of Object.entries(keywordsMap)) {
                            if (kws.some(k => str.includes(k))) tagCounts[category]++;
                        }
                    }
                });

                if (filteredList.length === 0) return showError('æœªæ£€æµ‹åˆ° Hanser ç›¸å…³è§†é¢‘ã€‚');
                const concentration = ((filteredList.length / totalScanned) * 100).toFixed(2) + '%';

                const aiRes = await fetch('/analyze-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        uid: clientId, 
                        videoData: filteredList,
                        stats: { total: totalScanned, matched: filteredList.length, percentage: concentration, breakdown: tagCounts }
                    })
                });

                const aiData = await aiRes.json();
                if (aiData.error) showError('AI åˆ†æå¤±è´¥: ' + aiData.error);
                else {
                    rawMarkdownContent = aiData.result;
                    renderReport(aiData.result, aiData.fromCache);
                }
            } catch (e) { console.error(e); showError('ç½‘ç»œè¯·æ±‚é”™è¯¯'); }
        }

        function renderReport(markdownText, fromCache) {
            document.getElementById('loading').style.display = 'none';
            const reportDiv = document.getElementById('report');
            reportDiv.style.display = 'block';
            reportDiv.innerHTML = marked.parse(markdownText);
            
            document.getElementById('btn-save').style.display = 'flex';
            document.getElementById('btn-dl-md').style.display = 'flex';
            document.getElementById('watermark').style.display = 'block';

            if (fromCache) document.getElementById('cache-badge').style.display = 'block';
        }

        function showError(msg) { document.getElementById('loading').innerHTML = `<p style="color:red">${msg}</p>`; }

        function downloadMarkdown() {
            if (!rawMarkdownContent) return alert("å†…å®¹ä¸ºç©º");
            const blob = new Blob([rawMarkdownContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Hanser_Report_${clientId}.md`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // === æ ¸å¿ƒä¿®å¤ï¼šæˆªå›¾åŠŸèƒ½ ===
        function saveAsImage() {
            const element = document.getElementById('capture-area');
            const btn = document.getElementById('btn-save');
            
            btn.innerText = 'ç”Ÿæˆä¸­...';
            btn.disabled = true;

            // 1. æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œé˜²æ­¢é¡¶éƒ¨è¢«åˆ‡
            window.scrollTo(0, 0);

            html2canvas(element, {
                scale: 2, // é«˜æ¸…
                useCORS: true, 
                backgroundColor: '#ffffff',
                // ã€ä¿®å¤ã€‘ç§»é™¤å¼ºåˆ¶é«˜åº¦ï¼Œè®© html2canvas è‡ªåŠ¨è®¡ç®—é«˜åº¦
                // è¿™æ ·å°±ä¸ä¼šå› ä¸ºç®—å¤šäº†è€Œå‡ºç°åº•éƒ¨å¤§ç™½è¾¹
                scrollY: -window.scrollY 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Hanser_AI_Report_${clientId}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                btn.innerText = 'ğŸ“¸ ä¿å­˜ä¸ºå›¾ç‰‡';
                btn.disabled = false;
            }).catch(err => {
                alert('å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨ç”µè„‘æµè§ˆå™¨æˆ–ä¸‹è½½æ–‡æœ¬');
                console.error(err);
                btn.innerText = 'ğŸ“¸ ä¿å­˜ä¸ºå›¾ç‰‡';
                btn.disabled = false;
            });
        }

        startAnalysis();
    </script>
</body>
</html>
