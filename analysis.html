<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanser æµ“åº¦ AI æ·±åº¦åˆ†æ</title>
    <!-- Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- ç½‘é¡µæˆªå›¾åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f5f7; color: #333; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #6c5ce7; }
        
        /* æŠ¥å‘Šå¡ç‰‡ (æˆ‘ä»¬è¦æˆªå›¾çš„åŒºåŸŸ) */
        .report-card { 
            background: white; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
        }
        
        .loading { text-align: center; color: #666; font-size: 18px; padding: 50px; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #6c5ce7; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Markdown æ ·å¼ä¼˜åŒ– */
        .markdown-body { line-height: 1.8; font-size: 16px; }
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 25px; color: #2c3e50; }
        .markdown-body h3 { margin-top: 20px; color: #6c5ce7; }
        .markdown-body ul { padding-left: 20px; }
        .markdown-body li { margin-bottom: 8px; }
        .markdown-body strong { color: #fb7299; background: #fff0f6; padding: 0 4px; border-radius: 4px; }
        .markdown-body blockquote { border-left: 4px solid #ddd; padding-left: 15px; color: #777; margin: 15px 0; }
        
        /* åº•éƒ¨æŒ‰é’®åŒº */
        .action-bar { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; font-size: 16px; transition: all 0.2s; }
        .btn-back { background: #e0e0e0; color: #333; }
        .btn-back:hover { background: #d0d0d0; }
        .btn-save { background: #6c5ce7; color: white; display: none; } /* é»˜è®¤éšè—ï¼ŒåŠ è½½å®Œæ˜¾ç¤º */
        .btn-save:hover { background: #5b4cc4; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ§  AI æ·±åº¦ç”»åƒæŠ¥å‘Š</h1>
        <p>åŸºäºæ‚¨æœ€è¿‘ä¸€å¹´çš„ Hanser ç›¸å…³æµè§ˆè®°å½•</p>
    </div>

    <!-- è¿™ä¸ª ID ç”¨äºæˆªå›¾ -->
    <div id="capture-area" class="report-card">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨åŠ è½½æ•°æ®å¹¶å¬å”¤ AI åˆ†æä¸­...<br><span style="font-size:12px;color:#999">è¿™å¯èƒ½éœ€è¦ 10-30 ç§’</span></div>
        </div>
        <div id="report" class="markdown-body" style="display:none;"></div>
        
        <!-- æ°´å° (ä»…æˆªå›¾æ—¶å¯è§ï¼Œå¢åŠ ä»ªå¼æ„Ÿ) -->
        <div id="watermark" style="display:none; text-align:center; margin-top:30px; color:#ccc; font-size:12px; border-top:1px dashed #eee; padding-top:10px;">
            Generated by Bilibili Hanser Analyzer
        </div>
    </div>

    <div class="action-bar">
        <a href="/" class="btn btn-back">è¿”å›æ‰«æé¡µ</a>
        <button id="btn-save" class="btn btn-save" onclick="saveAsImage()">ğŸ“¸ ä¿å­˜ä¸ºå›¾ç‰‡</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('clientId'); // å…¶å®æ˜¯ UID

        // å…³é”®è¯æ˜ å°„ (ä¸ index.html ä¿æŒä¸€è‡´)
        const keywordsMap = {
            'Hanseræœ¬ä½“': ['hanser', 'æ†¨è‰²', '255'],
            'é“¶ç‹¼/å¸ƒæ´›å¦®å¨…': ['é“¶ç‹¼', 'å¸ƒæ´›å¦®å¨…', 'æ¿é¸­', 'ç†ä¹‹å¾‹è€…'],
            'æ˜Ÿç©¹é“é“': ['æ˜Ÿç©¹é“é“', 'å´©åæ˜Ÿç©¹é“é“'],
            'å´©å3': ['å´©å3', 'honkai'],
            'ç¿»å”±/æ­Œæ›²': ['ç¿»å”±', 'æ­Œ', 'mv', 'cover'],
            'é¬¼ç•œ/æ•´æ´»': ['é¬¼ç•œ', 'äººåŠ›', 'å¡«è¯']
        };

        async function startAnalysis() {
            if (!clientId) return showError('æœªæ‰¾åˆ°ç”¨æˆ· IDï¼Œè¯·ä»ä¸»é¡µè·³è½¬è¿›å…¥ã€‚');

            try {
                // 1. åŠ è½½æ•°æ®
                const loadRes = await fetch('/load-data', { // æ³¨æ„ï¼šè¿™é‡Œæ”¹ç”¨ load-data æ¥å£ç›´æ¥æ‹¿å®Œæ•´æ•°æ®
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid: clientId })
                });
                const data = await loadRes.json();
                
                if (!data.list || data.list.length === 0) return showError('æš‚æ— æµè§ˆæ•°æ®ã€‚');

                // 2. ç­›é€‰ä¸ç»Ÿè®¡
                const totalScanned = data.list.length;
                const filteredList = [];
                const tagCounts = {};
                for (let key in keywordsMap) tagCounts[key] = 0;

                data.list.forEach(item => {
                    const str = (item.title + item.desc + item.tags + item.author).toLowerCase();
                    const allKeywords = Object.values(keywordsMap).flat();
                    if (allKeywords.some(k => str.includes(k))) {
                        filteredList.push(item);
                        for (let [category, kws] of Object.entries(keywordsMap)) {
                            if (kws.some(k => str.includes(k))) tagCounts[category]++;
                        }
                    }
                });

                if (filteredList.length === 0) return showError('æœªæ£€æµ‹åˆ° Hanser ç›¸å…³è§†é¢‘ã€‚');

                const concentration = ((filteredList.length / totalScanned) * 100).toFixed(2) + '%';

                // 3. å‘é€ç»™ AI
                const aiRes = await fetch('/analyze-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        videoData: filteredList,
                        stats: {
                            total: totalScanned,
                            matched: filteredList.length,
                            percentage: concentration,
                            breakdown: tagCounts
                        }
                    })
                });

                const aiData = await aiRes.json();
                if (aiData.error) showError('AI åˆ†æå¤±è´¥: ' + aiData.error);
                else renderReport(aiData.result);

            } catch (e) {
                console.error(e);
                showError('ç½‘ç»œè¯·æ±‚é”™è¯¯');
            }
        }

        function renderReport(markdownText) {
            document.getElementById('loading').style.display = 'none';
            const reportDiv = document.getElementById('report');
            reportDiv.style.display = 'block';
            reportDiv.innerHTML = marked.parse(markdownText);
            
            // æ˜¾ç¤ºä¿å­˜æŒ‰é’®
            document.getElementById('btn-save').style.display = 'block';
            document.getElementById('watermark').style.display = 'block';
        }

        function showError(msg) {
            document.getElementById('loading').innerHTML = `<p style="color:red">${msg}</p>`;
        }

        // === æ ¸å¿ƒï¼šä¿å­˜ä¸ºå›¾ç‰‡ ===
        function saveAsImage() {
            const element = document.getElementById('capture-area');
            const btn = document.getElementById('btn-save');
            
            btn.innerText = 'ç”Ÿæˆä¸­...';
            btn.disabled = true;

            html2canvas(element, {
                scale: 2, // 2å€æ¸…æ™°åº¦
                useCORS: true, // å…è®¸è·¨åŸŸå›¾ç‰‡
                backgroundColor: '#ffffff' // èƒŒæ™¯ç™½åº•
            }).then(canvas => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = `Hanser_AI_Report_${clientId}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                btn.innerText = 'ğŸ“¸ ä¿å­˜ä¸ºå›¾ç‰‡';
                btn.disabled = false;
            }).catch(err => {
                alert('å›¾ç‰‡ç”Ÿæˆå¤±è´¥');
                console.error(err);
                btn.innerText = 'ğŸ“¸ ä¿å­˜ä¸ºå›¾ç‰‡';
                btn.disabled = false;
            });
        }

        startAnalysis();
    </script>
</body>
</html>
